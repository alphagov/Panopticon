<% if flash[:notice].present? %>
  <div class="alert alert-success"><%= flash[:notice] %></div>
<% end %>

<% if artefact.errors.count > 0 %>
  <div class="alert alert-error">
    <ul>
      <% artefact.errors.full_messages.each do |message| %>
      <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<% if artefact.archived? %>
  <div class="alert alert-error">
    <h2>Stop! You can't edit this artefact because it has been archived.</h2>
  </div>
<% else %>
  <%= semantic_bootstrap_nested_form_for(artefact, :html => { :class => 'artefact', :id => 'edit_artefact'}) do |f| %>

    <div class="row-fluid">
      <div class="span8">
        <% if artefact.new_record? %>
        <div class="well">
          <%= f.input :name %>
          <%= f.input :slug %>

          <%= f.input :kind, :collection => non_whitehall_formats.map { |s| [s.humanize, s]}, :as => :select, :class => "span6", :prompt => "Select a kind" %>
          <%= f.input :owning_app, :as => :hidden, :input_html => {:value => "publisher"} %>
        </div>
        <% end %>

        <div class="well">
          <%= render :partial => 'module_image', :locals => { :f => f, :artefact => artefact } %>
        </div>

        <div class="well">
          <%= f.inputs "Organisations" do %>
            <%= f.input :organization_name, :label => "Is the content about specific member(s) or startup(s)?", :collection => @organizations, :as => :select, :input_html => {:class => "span8"}, :multiple => true, :size => 5 %>
          <% end %>
        </div>

        <div class="well">
          <%= f.inputs "Related content" do %>
            <div class="related-artefacts fieldset-section">
              <label class="section-label">Related artefacts <span class="hint">(click and drag to reorder)</span></label>

              <div class="nested-item-group related-artefact-group">
                <% if artefact.related_artefact_ids.length > 0 %>
                  <% artefact.related_artefact_ids.each do |related_artefact_id| %>
                    <%= render :partial => 'related_artefact', :locals => { related_artefact_id: related_artefact_id, is_template: false } %>
                  <% end %>
                <% else %>
                  <%= render :partial => 'related_artefact', :locals => { related_artefact_id: nil, is_template: false } %>
                <% end %>
              </div>

              <%= render :partial => 'related_artefact', :locals => { related_artefact_id: nil, is_template: true } %>
              <button id="add-related" class="btn btn-success" type="button">Add another related item</button>
            </div>
            <div class="related-external-links fieldset-section">
              <label class="section-label">Related external links</label>
              <%= f.fields_for :external_links do |link| %>
                <div class="row-fluid nested-item">
                  <div class="span4">
                    <%= link.label :title, "Title" %>
                    <%= link.text_field :title, :class => "span12" %>
                  </div>
                  <div class="span5">
                    <%= link.label :url, "URL" %>
                    <%= link.text_field :url, :class => "span12" %>
                  </div>
                  <div class="span3">
                    <br>
                    <%= link.link_to_remove "Remove this URL", :class => "remove-row" %>
                  </div>
                </div>
              <% end %>
              <%= f.link_to_add "Add related external link", :external_links, :class => "btn btn-success" %>
            </div>
          <% end %>
        </div>

        <div class="well">
          <input type="hidden" name="artefact[sections][]" value="" />
          <%= f.inputs "Tags" do %>
            <% @tags.each do |type, tags| %>
              <div class="fieldset-section tag <%= type.to_s %>-tags <%= "hidden" unless artefact.kind == type.to_s  %>">
                <label class="section-label" for="artefact[<%= type %>][]"><%= type.to_s.humanize %> category</label>
                <div class="nested-item-group">
                  <div class="row-fluid nested-item">
                    <% if artefact.send("#{type}_ids").length > 0 %>
                      <% artefact.send("#{type}_ids").each do |tag_id| %>
                        <%= render :partial => 'tag_section', :locals => {:tag_id => tag_id, :tag_collection => tags, :type => type} %>
                      <% end %>
                    <% else %>
                      <%= render :partial => 'tag_section', :locals => {:tag_id => nil, :tag_collection => tags, :type => type} %>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>

        </div>
      </div>

      <div class="span4">

        <div class="well <%= "hidden" unless ["event", "course_instance"].include?(artefact.kind)  %>">
          <%= f.inputs "Featured" do %>
            <%= f.input :featured, :label => "Does this content want to be featured?", :collection => Tag.where(:tag_id => 'featured').map { |t| [t.title, t.tag_id]}, 
              :as => :check_boxes, 
              :input_html => {:checked => !artefact.featured.blank? } %>
          <% end %>
        </div>

        <div class="well">
          <%= f.inputs "Role" do %>
          <%= f.input :roles, :collection => @roles, :as => :check_boxes, :label => 'What project(s) is this content for?' %>
          <% end %>
        </div>

        <div class="well">
          <%= render :partial => "author", :locals => { :f => f } %>
        </div>

        <div class="well">
          <%= f.inputs "Nodes" do %>
            <%= f.input :node, :collection => @nodes, :label => 'Is the content about specific node(s)?', :as => :select, :input_html => {:class => "span8"}, :multiple => true, :size => 5 %>
          <% end %>
        </div>

        <div class="well">
          <%= f.input :language, :collection => {"English" => "en", "Welsh" => "cy"}, :as => :select, :input_html => { :class => "span8" }, :include_blank => false %>
          <%= f.input :business_proposition, :label => 'Is this business content?', :as => :boolean unless @disable_business_content %>
          <%= f.input :need_extended_font, :label => "Does this artefact need the extra font files?", :as => :boolean unless @disable_extra_fonts %>
        </div>

        <% if @artefact.persisted? && @artefact.owning_app.present? %>
          <div class="well owning-app">
            <p>This content is managed in <strong><%= @artefact.owning_app.humanize %></strong>.</p>
            <% if @artefact.owning_app == "publisher" %>
              <%= link_to "Edit in Publisher", admin_url_for_edition(@artefact), :class => "btn" %>
            <% end %>
          </div>
        <% end %>

      </div>
    </div>

    <hr>

    <%= f.submit :value => "Save and continue editing", :class => "btn btn-primary" %>
    <%= f.submit :value => "Save and go to item", :class => "btn" %>
  <% end %>
<% end %>

<%= content_for :extra_javascript do %>
  <script type="text/javascript">
    $(".chzn-select").chosen();

    $('.related-artefact-group').sortable();

    if ($('.artefact-section').size() == 1) {
      $('.remove-section').hide();
    }
  </script>
<% end %>
