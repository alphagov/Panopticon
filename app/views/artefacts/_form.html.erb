<div id="panopticon" class="ui-widget-content">

  <%= semantic_form_for(artefact, :html => { :class => 'artefact' }) do |f| %>
    <%= f.inputs :name => "Basic information" do %>
      <%= f.input :name %>
      <%= f.input :slug %>
      <%= f.input :tags %>
      <%= f.input :section, :as => :select, :collection => Artefact::SECTIONS %>
      <%= f.input :department, :as => :select, :collection => Department.all %>
      <%= f.input :contact %>
      <%= f.input :audiences, :as => :check_boxes, :collection => Audience.all, :title => "Who is likely to use this information?" %>
      <% if artefact.new_record? %>
        <%= f.input :kind, :collection => Artefact::FORMATS, :as => :select %>
      <% end %>
    <% end %>
    <%= f.inputs "Related items", :class => "related" do %>
      <% f.semantic_fields_for :related_items, related_items_for(artefact) do |related_item| %>
        <%= related_item.input :artefact, :as => :select, :collection => Artefact.in_alphabetical_order, :label => false %>
        <%= related_item.input :sort_key, :as => :hidden %>
      <% end %>
    <% end %>
    <% if artefact.new_record? %>
      <%= f.input :need_id, :as => :hidden %>
      <%= f.input :owning_app, :as => :hidden, :value => "publisher" %>
    <% end %>
    <%= f.submit :value => "Satisfy my need", :class => "button" %>
  <% end %>

<%= javascript_tag do %>
(function() {
  var blankByDefault = ($("#artefact_slug").attr('value') != '');
  var generateSlug = function generateSlug() {
    if(blankByDefault) { return }
    var title = $("#artefact_name").val();
    var slug = title.toLowerCase()
      .replace(/[^\w ]+/g, '')
      .replace(/ +/g, '-')
      .replace(/^-+|-+$/, '')
    $("#artefact_slug").val(slug);
  }
  $("#artefact_name").change(generateSlug)
  $("#artefact_name").bind('keyup', generateSlug)
}())
<% end %>

</div>
